---
title: "Build Neighborhood Maps"
author: "Christopher Prener, Ph.D., Carter Hanford"
date: '(`r format(Sys.time(), "%B %d, %Y")`)'
output: 
  github_document: default
  html_notebook: default 
---

## Introduction
This notebook generates neighborhood maps by decennial year to 2010, then from years 2011-2017.

## Dependencies
This notebook requires a number of different `R` packages:

```{r load-packages}
# tidyverse packages
library(dplyr)         # data wrangling
library(readr)         # working with csv data
library(stringr)       # string tools
library(ggplot2)       # mapping
library(ggthemes)      # base color

# spatial packages
library(sf)            # working with spatial data
library(areal)         # interpolation
library(tidycensus)    # census api access
library(tigris)        # tiger/line api access

# other packages
library(here)          # file path management
library(testthat)      # unit testing
library(measurements)  # unit converting
library(RColorBrewer)  # colors
library(viridis)       # more colors
```

## Load Source
Here we will load necessary functions for formatting the neighborhood maps and saving them into our results folder.

```{r}
source(here("source", "cp_sequoiaTheme.R"))
source(here("source", "cp_plotSave.R"))
```


## Load Data
In this section, we'll be using the STL Population and Race data by neighborhod located in the clean folder under data.

```{r data-load}
STL_Pop <- read_csv(here("data", "clean", "STL_PopByNhood.csv"))
STL_Race <- read_csv(here("data", "clean", "STL_RaceByNhood.csv"))

st_read(here("data", "spatial", "nhood", "BND_Nhd88_cw.shp"), 
                    stringsAsFactors = FALSE) %>%
  st_transform(crs = 26915) -> nhoodGEO
```


## Merge STL Pop/Race
To generate the appropriate maps, we need to merge the STL population and race by neighborhood data in the clean folder. The join turns generates spatial data that we can map to the city of St. Louis.

```{r join}
nhood <- left_join(STL_Pop, STL_Race, by = "NHD_NUM")

nhoods <- left_join(nhood, nhoodGEO, by = "NHD_NUM") 
```

Next, for formatting purposes, we need to convert from m^2 to km^2:

```{r convert}
nhoods %>%
  mutate(sqkm = st_area(geometry)) %>%
  mutate(sqkm = conv_unit(sqkm, from = "m2", to = "km2")) -> nhoods
```

## Maps - Neighborhoods by Race
Now that we have our spatial data formatted and ready to go, we can start to map the neighborhoods by year.  Using `ggplot`, we'll generate racial composition maps of St. Louis neighborhoods. Starting in 1940, we will generate 15 separate maps, 1940-2010 (decennial), and 2011-2017.  This section will be lengthy and will use recycled code from the first block, so we'll refrain from narrative.

### 1940
A quick note, census data from 1940 does not have a `black` percentage, so we will use `non-white`.

```{r nhood1940}
nhood1940 <- ggplot() +
  geom_sf(data = nhoods, mapping = aes(fill = (nonwhite40/pop40)*100), color = NA) +
  scale_fill_distiller(palette = "RdPu", name = "% Non-white", trans = "reverse") +
  labs(
    title = "% Nonwhite",
    subtitle = "St. Louis City - 1940",
    caption = "Map by Christopher Prener, PhD., Carter Hanford") +
  cp_sequoiaTheme(base_size = 20, background = "white", map = TRUE)

print(nhood1940)
```

```{r save1940}
cp_plotSave(here("results", "nhood1940.png"), nhood1940, preset = "lg", dpi = 500)
```

### 1950

```{r nhood1950}
nhood1950 <- ggplot() +
  geom_sf(data = nhoods, mapping = aes(fill = (black50/pop50)*100), color = NA) +
  scale_fill_distiller(palette = "RdPu", name = "% Black", trans = "reverse") +
  labs(
    title = "% Black",
    subtitle = "St. Louis City - 1950",
    caption = "Map by Christopher Prener, PhD., Carter Hanford") +
  cp_sequoiaTheme(base_size = 20, background = "white", map = TRUE)

print(nhood1950)
```

```{r save1950}
cp_plotSave(here("results", "nhood1950.png"), nhood1950, preset = "lg", dpi = 500)
```

### 1960

```{r nhood1960}
nhood1960 <- ggplot() +
  geom_sf(data = nhoods, mapping = aes(fill = (black60/pop60)*100), color = NA) +
  scale_fill_distiller(palette = "RdPu", name = "% Black", trans = "reverse") +
  labs(
    title = "% Black",
    subtitle = "St. Louis City - 1960",
    caption = "Map by Christopher Prener, PhD., Carter Hanford") +
  cp_sequoiaTheme(base_size = 20, background = "white", map = TRUE)

print(nhood1960)
```

```{r save1960}
cp_plotSave(here("results", "nhood1960.png"), nhood1960, preset = "lg", dpi = 500)
```

### 1970

```{r nhood1970}
nhood1970 <- ggplot() +
  geom_sf(data = nhoods, mapping = aes(fill = (black70/pop70)*100), color = NA) +
  scale_fill_distiller(palette = "RdPu", name = "% Black", trans = "reverse") +
  labs(
    title = "% Black",
    subtitle = "St. Louis City - 1970",
    caption = "Map by Christopher Prener, PhD., Carter Hanford") +
  cp_sequoiaTheme(base_size = 20, background = "white", map = TRUE)

print(nhood1970)
```

```{r save1970}
cp_plotSave(here("results", "nhood1970.png"), nhood1970, preset = "lg", dpi = 500)
```

### 1980

```{r nhood1980}
nhood1980 <- ggplot() +
  geom_sf(data = nhoods, mapping = aes(fill = (black80/pop80)*100), color = NA) +
  scale_fill_distiller(palette = "RdPu", name = "% Black", trans = "reverse") +
  labs(
    title = "% Black",
    subtitle = "St. Louis City - 1980",
    caption = "Map by Christopher Prener, PhD., Carter Hanford") +
  cp_sequoiaTheme(base_size = 20, background = "white", map = TRUE)

print(nhood1980)
```

```{r save1980}
cp_plotSave(here("results", "nhood1980.png"), nhood1980, preset = "lg", dpi = 500)
```

### 1990

```{r nhood1990}
nhood1990 <- ggplot() +
  geom_sf(data = nhoods, mapping = aes(fill = (black90/pop90)*100), color = NA) +
  scale_fill_distiller(palette = "RdPu", name = "% Black", trans = "reverse") +
  labs(
    title = "% Black",
    subtitle = "St. Louis City - 1990",
    caption = "Map by Christopher Prener, PhD., Carter Hanford") +
  cp_sequoiaTheme(base_size = 20, background = "white", map = TRUE)

print(nhood1990)
```

```{r save1990}
cp_plotSave(here("results", "nhood1990.png"), nhood1990, preset = "lg", dpi = 500)
```

### 2000

```{r nhood2000}
nhood2000 <- ggplot() +
  geom_sf(data = nhoods, mapping = aes(fill = (black00/pop00)*100), color = NA) +
  scale_fill_distiller(palette = "RdPu", name = "% Black", trans = "reverse") +
  labs(
    title = "% Black",
    subtitle = "St. Louis City - 2000",
    caption = "Map by Christopher Prener, PhD., Carter Hanford") +
  cp_sequoiaTheme(base_size = 20, background = "white", map = TRUE)

print(nhood2000)
```

```{r save2000}
cp_plotSave(here("results", "nhood2000.png"), nhood2000, preset = "lg", dpi = 500)
```

### 2010

```{r nhood2010}
nhood2010 <- ggplot() +
  geom_sf(data = nhoods, mapping = aes(fill = (black10/pop10)*100), color = NA) +
  scale_fill_distiller(palette = "RdPu", name = "% Black", trans = "reverse") +
  labs(
    title = "% Black",
    subtitle = "St. Louis City - 2010",
    caption = "Map by Christopher Prener, PhD., Carter Hanford") +
  cp_sequoiaTheme(base_size = 20, background = "white", map = TRUE)

print(nhood2010)
```

```{r save2010}
cp_plotSave(here("results", "nhood2010.png"), nhood2010, preset = "lg", dpi = 500)
```

### 2011

```{r nhood2011}
nhood2011 <- ggplot() +
  geom_sf(data = nhoods, mapping = aes(fill = (black11/pop11)*100), color = NA) +
  scale_fill_distiller(palette = "RdPu", name = "% Black", trans = "reverse") +
  labs(
    title = "% Black",
    subtitle = "St. Louis City - 2011",
    caption = "Map by Christopher Prener, PhD., Carter Hanford") +
  cp_sequoiaTheme(base_size = 20, background = "white", map = TRUE)

print(nhood2011)
```

```{r save2011}
cp_plotSave(here("results", "nhood2011.png"), nhood2011, preset = "lg", dpi = 500)
```

### 2012

```{r nhood2012}
nhood2012 <- ggplot() +
  geom_sf(data = nhoods, mapping = aes(fill = (black12/pop12)*100), color = NA) +
  scale_fill_distiller(palette = "RdPu", name = "% Black", trans = "reverse") +
  labs(
    title = "% Black",
    subtitle = "St. Louis City - 2012",
    caption = "Map by Christopher Prener, PhD., Carter Hanford") +
  cp_sequoiaTheme(base_size = 20, background = "white", map = TRUE)

print(nhood2012)
```

```{r save2012}
cp_plotSave(here("results", "nhood2012.png"), nhood2012, preset = "lg", dpi = 500)
```

### 2013

```{r nhood2013}
nhood2013 <- ggplot() +
  geom_sf(data = nhoods, mapping = aes(fill = (black13/pop13)*100), color = NA) +
  scale_fill_distiller(palette = "RdPu", name = "% Black", trans = "reverse") +
  labs(
    title = "% Black",
    subtitle = "St. Louis City - 2013",
    caption = "Map by Christopher Prener, PhD., Carter Hanford") +
  cp_sequoiaTheme(base_size = 20, background = "white", map = TRUE)

print(nhood2013)
```

```{r save2013}
cp_plotSave(here("results", "nhood2013.png"), nhood2013, preset = "lg", dpi = 500)
```

### 2014

```{r nhood2014}
nhood2014 <- ggplot() +
  geom_sf(data = nhoods, mapping = aes(fill = (black14/pop14)*100), color = NA) +
  scale_fill_distiller(palette = "RdPu", name = "% Black", trans = "reverse") +
  labs(
    title = "% Black",
    subtitle = "St. Louis City - 2014",
    caption = "Map by Christopher Prener, PhD., Carter Hanford") +
  cp_sequoiaTheme(base_size = 20, background = "white", map = TRUE)

print(nhood2014)
```

```{r save2014}
cp_plotSave(here("results", "nhood2014.png"), nhood2014, preset = "lg", dpi = 500)
```

### 2015

```{r nhood2015}
nhood2015 <- ggplot() +
  geom_sf(data = nhoods, mapping = aes(fill = (black15/pop15)*100), color = NA) +
  scale_fill_distiller(palette = "RdPu", name = "% Black", trans = "reverse") +
  labs(
    title = "% Black",
    subtitle = "St. Louis City - 2015",
    caption = "Map by Christopher Prener, PhD., Carter Hanford") +
  cp_sequoiaTheme(base_size = 20, background = "white", map = TRUE)

print(nhood2015)
```

```{r save2015}
cp_plotSave(here("results", "nhood2015.png"), nhood2015, preset = "lg", dpi = 500)
```

### 2016

```{r nhood2016}
nhood2016 <- ggplot() +
  geom_sf(data = nhoods, mapping = aes(fill = (black16/pop16)*100), color = NA) +
  scale_fill_distiller(palette = "RdPu", name = "% Black", trans = "reverse") +
  labs(
    title = "% Black",
    subtitle = "St. Louis City - 2016",
    caption = "Map by Christopher Prener, PhD., Carter Hanford") +
  cp_sequoiaTheme(base_size = 20, background = "white", map = TRUE)

print(nhood2016)
```

```{r save2016}
cp_plotSave(here("results", "nhood2016.png"), nhood2016, preset = "lg", dpi = 500)
```

### 2017

```{r nhood2017}
nhood2017 <- ggplot() +
  geom_sf(data = nhoods, mapping = aes(fill = (black17/pop17)*100), color = NA) +
  scale_fill_distiller(palette = "RdPu", name = "% Black", trans = "reverse") +
  labs(
    title = "% Black",
    subtitle = "St. Louis City - 2017",
    caption = "Map by Christopher Prener, PhD., Carter Hanford") +
  cp_sequoiaTheme(base_size = 20, background = "white", map = TRUE)

print(nhood2017)
```

```{r save2017}
cp_plotSave(here("results", "nhood2017.png"), nhood2017, preset = "lg", dpi = 500)
```

## Maps - Neighborhoods by Population
Next we want to make the same maps as above, but of total population. Using `ggplot again, we'll generate population composition maps of St. Louis neighborhoods. Starting in 1940, we will generate 15 separate maps, 1940-2010 (decennial), and 2011-2017.  This section will follow similar style to the code above, and will use recycled code from the first block.

### 1940 

```{r nhoodpop1940}
nhoodpop1940 <- ggplot() +
  geom_sf(data = nhoods, mapping = aes(fill = pop40), color = NA) +
  scale_fill_distiller(palette = "Blues", name = "Total Pop", trans = "reverse") +
  labs(
    title = "Total Population",
    subtitle = "St. Louis City - 1940",
    caption = "Map by Christopher Prener, PhD., Carter Hanford") +
  cp_sequoiaTheme(base_size = 20, background = "white", map = TRUE)

print(nhoodpop1940)
```

```{r save1940pop}
cp_plotSave(here("results", "nhoodpop1940.png"), nhoodpop1940, preset = "lg", dpi = 500)
```

### 1950

```{r nhoodpop1950}
nhoodpop1950 <- ggplot() +
  geom_sf(data = nhoods, mapping = aes(fill = pop50), color = NA) +
  scale_fill_distiller(palette = "Blues", name = "Total Pop", trans = "reverse") +
  labs(
    title = "Total Population",
    subtitle = "St. Louis City - 1950",
    caption = "Map by Christopher Prener, PhD., Carter Hanford") +
  cp_sequoiaTheme(base_size = 20, background = "white", map = TRUE)

print(nhoodpop1950)
```

```{r save1950pop}
cp_plotSave(here("results", "nhoodpop1950.png"), nhoodpop1950, preset = "lg", dpi = 500)
```

### 1960

```{r nhoodpop1960}
nhoodpop1960 <- ggplot() +
  geom_sf(data = nhoods, mapping = aes(fill = pop60), color = NA) +
  scale_fill_distiller(palette = "Blues", name = "Total Pop", trans = "reverse") +
  labs(
    title = "Total Population",
    subtitle = "St. Louis City - 1960",
    caption = "Map by Christopher Prener, PhD., Carter Hanford") +
  cp_sequoiaTheme(base_size = 20, background = "white", map = TRUE)

print(nhoodpop1960)
```

```{r save1960pop}
cp_plotSave(here("results", "nhoodpop1960.png"), nhoodpop1960, preset = "lg", dpi = 500)
```

### 1970

```{r nhoodpop1970}
nhoodpop1970 <- ggplot() +
  geom_sf(data = nhoods, mapping = aes(fill = pop70), color = NA) +
  scale_fill_distiller(palette = "Blues", name = "Total Pop", trans = "reverse") +
  labs(
    title = "Total Population",
    subtitle = "St. Louis City - 1970",
    caption = "Map by Christopher Prener, PhD., Carter Hanford") +
  cp_sequoiaTheme(base_size = 20, background = "white", map = TRUE)

print(nhoodpop1970)
```

```{r save1970pop}
cp_plotSave(here("results", "nhoodpop1970.png"), nhoodpop1970, preset = "lg", dpi = 500)
```

### 1980

```{r nhoodpop1980}
nhoodpop1980 <- ggplot() +
  geom_sf(data = nhoods, mapping = aes(fill = pop80), color = NA) +
  scale_fill_distiller(palette = "Blues", name = "Total Pop", trans = "reverse") +
  labs(
    title = "Total Population",
    subtitle = "St. Louis City - 1980",
    caption = "Map by Christopher Prener, PhD., Carter Hanford") +
  cp_sequoiaTheme(base_size = 20, background = "white", map = TRUE)

print(nhoodpop1980)
```

```{r save1980pop}
cp_plotSave(here("results", "nhoodpop1980.png"), nhoodpop1980, preset = "lg", dpi = 500)
```

### 1990

### 2000

```{r nhoodpop2000}
nhoodpop2000 <- ggplot() +
  geom_sf(data = nhoods, mapping = aes(fill = pop00), color = NA) +
  scale_fill_distiller(palette = "Blues", name = "Total Pop", trans = "reverse") +
  labs(
    title = "Total Population",
    subtitle = "St. Louis City - 2000",
    caption = "Map by Christopher Prener, PhD., Carter Hanford") +
  cp_sequoiaTheme(base_size = 20, background = "white", map = TRUE)

print(nhoodpop2000)
```

```{r save2000pop}
cp_plotSave(here("results", "nhoodpop2000.png"), nhoodpop2000, preset = "lg", dpi = 500)
```

### 2010

```{r nhoodpop2010}
nhoodpop2010 <- ggplot() +
  geom_sf(data = nhoods, mapping = aes(fill = pop10), color = NA) +
  scale_fill_distiller(palette = "Blues", name = "Total Pop", trans = "reverse") +
  labs(
    title = "Total Population",
    subtitle = "St. Louis City - 2010",
    caption = "Map by Christopher Prener, PhD., Carter Hanford") +
  cp_sequoiaTheme(base_size = 20, background = "white", map = TRUE)

print(nhoodpop2010)
```

```{r save2010pop}
cp_plotSave(here("results", "nhoodpop2010.png"), nhoodpop2010, preset = "lg", dpi = 500)
```

### 2011

```{r nhoodpop2011}
nhoodpop2011 <- ggplot() +
  geom_sf(data = nhoods, mapping = aes(fill = pop11), color = NA) +
  scale_fill_distiller(palette = "Blues", name = "Total Pop", trans = "reverse") +
  labs(
    title = "Total Population",
    subtitle = "St. Louis City - 2011",
    caption = "Map by Christopher Prener, PhD., Carter Hanford") +
  cp_sequoiaTheme(base_size = 20, background = "white", map = TRUE)

print(nhoodpop2011)
```

```{r save2011pop}
cp_plotSave(here("results", "nhoodpop2011.png"), nhoodpop2011, preset = "lg", dpi = 500)
```

### 2012

```{r nhoodpop2012}
nhoodpop2012 <- ggplot() +
  geom_sf(data = nhoods, mapping = aes(fill = pop12), color = NA) +
  scale_fill_distiller(palette = "Blues", name = "Total Pop", trans = "reverse") +
  labs(
    title = "Total Population",
    subtitle = "St. Louis City - 2012",
    caption = "Map by Christopher Prener, PhD., Carter Hanford") +
  cp_sequoiaTheme(base_size = 20, background = "white", map = TRUE)

print(nhoodpop2012)
```

```{r save2012pop}
cp_plotSave(here("results", "nhoodpop2012.png"), nhoodpop2012, preset = "lg", dpi = 500)
```

### 2013

```{r nhoodpop2013}
nhoodpop2013 <- ggplot() +
  geom_sf(data = nhoods, mapping = aes(fill = pop13), color = NA) +
  scale_fill_distiller(palette = "Blues", name = "Total Pop", trans = "reverse") +
  labs(
    title = "Total Population",
    subtitle = "St. Louis City - 2013",
    caption = "Map by Christopher Prener, PhD., Carter Hanford") +
  cp_sequoiaTheme(base_size = 20, background = "white", map = TRUE)

print(nhoodpop2013)
```

```{r save2013pop}
cp_plotSave(here("results", "nhoodpop2013.png"), nhoodpop2013, preset = "lg", dpi = 500)
```

### 2014

```{r nhoodpop2014}
nhoodpop2014 <- ggplot() +
  geom_sf(data = nhoods, mapping = aes(fill = pop14), color = NA) +
  scale_fill_distiller(palette = "Blues", name = "Total Pop", trans = "reverse") +
  labs(
    title = "Total Population",
    subtitle = "St. Louis City - 2014",
    caption = "Map by Christopher Prener, PhD., Carter Hanford") +
  cp_sequoiaTheme(base_size = 20, background = "white", map = TRUE)

print(nhoodpop2014)
```

```{r save2014pop}
cp_plotSave(here("results", "nhoodpop2014.png"), nhoodpop2014, preset = "lg", dpi = 500)
```

### 2015

```{r nhoodpop2015}
nhoodpop2015 <- ggplot() +
  geom_sf(data = nhoods, mapping = aes(fill = pop15), color = NA) +
  scale_fill_distiller(palette = "Blues", name = "Total Pop", trans = "reverse") +
  labs(
    title = "Total Population",
    subtitle = "St. Louis City - 2015",
    caption = "Map by Christopher Prener, PhD., Carter Hanford") +
  cp_sequoiaTheme(base_size = 20, background = "white", map = TRUE)

print(nhoodpop2015)
```

```{r save2015pop}
cp_plotSave(here("results", "nhoodpop2015.png"), nhoodpop2015, preset = "lg", dpi = 500)
```

### 2016

```{r nhoodpop2016}
nhoodpop2016 <- ggplot() +
  geom_sf(data = nhoods, mapping = aes(fill = pop16), color = NA) +
  scale_fill_distiller(palette = "Blues", name = "Total Pop", trans = "reverse") +
  labs(
    title = "Total Population",
    subtitle = "St. Louis City - 2016",
    caption = "Map by Christopher Prener, PhD., Carter Hanford") +
  cp_sequoiaTheme(base_size = 20, background = "white", map = TRUE)

print(nhoodpop2016)
```

```{r save2016pop}
cp_plotSave(here("results", "nhoodpop2016.png"), nhoodpop2016, preset = "lg", dpi = 500)
```

### 2017

```{r nhoodpop2017}
nhoodpop2017 <- ggplot() +
  geom_sf(data = nhoods, mapping = aes(fill = pop17), color = NA) +
  scale_fill_distiller(palette = "Blues", name = "Total Pop", trans = "reverse") +
  labs(
    title = "Total Population",
    subtitle = "St. Louis City - 2017",
    caption = "Map by Christopher Prener, PhD., Carter Hanford") +
  cp_sequoiaTheme(base_size = 20, background = "white", map = TRUE)

print(nhoodpop2017)
```

```{r save2017pop}
cp_plotSave(here("results", "nhoodpop2017.png"), nhoodpop2017, preset = "lg", dpi = 500)
```
